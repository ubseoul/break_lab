<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BREAK LAB | Universal Drum Loop Slicer</title>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg-primary: #0a0a0b; --bg-secondary: #121214; --bg-tertiary: #1a1a1d; --bg-elevated: #222226;
            --accent: #ff6b35; --accent-glow: rgba(255,107,53,0.4); --text-primary: #fafafa;
            --text-secondary: #a0a0a5; --text-muted: #606065; --border: rgba(255,255,255,0.08);
            --success: #4ade80; --danger: #f87171;
        }
        html, body { font-family: 'Instrument Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; min-height: 100dvh; overflow-x: hidden; }
        .app { display: flex; flex-direction: column; min-height: 100vh; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #f7c59f); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: var(--bg-primary); }
        .logo-text { font-weight: 700; font-size: 18px; }
        .logo-text span { color: var(--accent); }
        .main { flex: 1; display: flex; flex-direction: column; padding: 16px; gap: 16px; max-width: 800px; margin: 0 auto; width: 100%; }
        .section { background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
        .section-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .section-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .loop-tabs { display: flex; gap: 4px; }
        .loop-tab { padding: 6px 12px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 500; cursor: pointer; }
        .loop-tab.active { background: var(--accent); color: var(--bg-primary); }
        .loop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; padding: 12px; max-height: 180px; overflow-y: auto; }
        .loop-card { background: var(--bg-tertiary); border-radius: 10px; padding: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .loop-card:hover { background: var(--bg-elevated); }
        .loop-card.active { border-color: var(--accent); background: rgba(255,107,53,0.1); }
        .loop-card-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .loop-card-meta { font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .upload-card { border: 2px dashed var(--border); background: transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; min-height: 70px; }
        .upload-card:hover { border-color: var(--accent); }
        .upload-card svg { color: var(--text-muted); }
        .upload-card span { font-size: 11px; color: var(--text-muted); }
        .waveform-info { display: flex; align-items: center; gap: 12px; }
        .waveform-name { font-size: 14px; font-weight: 600; }
        .waveform-bpm { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); background: rgba(255,107,53,0.15); padding: 4px 8px; border-radius: 4px; }
        .slice-controls { display: flex; align-items: center; gap: 8px; }
        .slice-count { display: flex; align-items: center; background: var(--bg-tertiary); border-radius: 6px; padding: 2px; }
        .slice-btn { width: 28px; height: 28px; border-radius: 4px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 16px; }
        .slice-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .slice-value { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; min-width: 28px; text-align: center; }
        .waveform-container { position: relative; height: 100px; background: var(--bg-tertiary); cursor: crosshair; }
        .waveform-canvas { width: 100%; height: 100%; display: block; }
        .slice-markers { position: absolute; inset: 0; pointer-events: none; }
        .slice-marker { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.2); }
        .pads-section { padding: 16px; }
        .pads-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .pads-mode { display: flex; gap: 4px; background: var(--bg-tertiary); padding: 3px; border-radius: 8px; }
        .mode-btn { padding: 6px 12px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); font-size: 11px; font-weight: 600; cursor: pointer; }
        .mode-btn.active { background: var(--bg-elevated); color: var(--text-primary); }
        .pads-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .pad { aspect-ratio: 1; border-radius: 12px; border: 2px solid var(--border); background: var(--bg-tertiary); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; user-select: none; position: relative; overflow: hidden; }
        .pad::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle, var(--accent-glow), transparent); opacity: 0; transition: opacity 0.1s; }
        .pad:hover { border-color: var(--text-muted); background: var(--bg-elevated); }
        .pad:active, .pad.active { transform: scale(0.95); border-color: var(--accent); }
        .pad.active::before { opacity: 1; }
        .pad.playing { border-color: var(--success); box-shadow: 0 0 20px rgba(74,222,128,0.3); }
        .pad.playing::before { background: radial-gradient(circle, rgba(74,222,128,0.4), transparent); opacity: 1; }
        .pad-number { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; z-index: 1; }
        .pad-key { font-size: 10px; color: var(--text-muted); margin-top: 2px; z-index: 1; }
        .controls-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .control-group { background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border); padding: 16px; }
        .control-group-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; }
        .transport-buttons { display: flex; gap: 8px; }
        .transport-btn { flex: 1; height: 56px; border-radius: 12px; border: 2px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .transport-btn:hover { background: var(--bg-elevated); }
        .transport-btn.primary { background: var(--accent); border-color: var(--accent); color: var(--bg-primary); }
        .tempo-control { display: flex; align-items: center; gap: 12px; }
        .tempo-display { flex: 1; text-align: center; }
        .tempo-value { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; line-height: 1; }
        .tempo-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .tempo-btn { width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); font-size: 18px; cursor: pointer; }
        .tempo-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .tap-tempo { width: 100%; height: 44px; margin-top: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; }
        .effects-section { padding: 16px; }
        .effects-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .effect-btn { padding: 12px 8px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; }
        .effect-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .effect-btn.active { background: rgba(255,107,53,0.2); border-color: var(--accent); color: var(--accent); }
        .effect-knobs { display: flex; gap: 12px; }
        .effect-knob { flex: 1; }
        .effect-knob-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; display: block; }
        .effect-slider { width: 100%; height: 6px; -webkit-appearance: none; background: var(--bg-tertiary); border-radius: 3px; }
        .effect-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .seq-actions { display: flex; gap: 8px; }
        .seq-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; }
        .seq-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .seq-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg-primary); }
        .seq-grid { padding: 16px; overflow-x: auto; }
        .seq-row { display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
        .seq-label { width: 24px; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); text-align: right; flex-shrink: 0; }
        .seq-steps { display: flex; gap: 2px; flex: 1; }
        .seq-step { flex: 1; min-width: 18px; height: 24px; border-radius: 4px; background: var(--bg-tertiary); border: 1px solid transparent; cursor: pointer; }
        .seq-step:hover { background: var(--bg-elevated); }
        .seq-step.active { background: var(--accent); }
        .seq-step.current { box-shadow: inset 0 0 0 2px var(--text-primary); }
        .seq-step:nth-child(4n+1) { border-left: 2px solid var(--border); }
        .looper-section { padding: 16px; }
        .looper-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .looper-status { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); padding: 4px 8px; background: var(--bg-tertiary); border-radius: 4px; }
        .looper-status.recording { color: var(--danger); background: rgba(248,113,113,0.15); }
        .looper-status.playing { color: var(--success); background: rgba(74,222,128,0.15); }
        .looper-display { display: flex; gap: 4px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 12px; flex-wrap: wrap; min-height: 48px; }
        .looper-step { width: 24px; height: 24px; border-radius: 4px; background: var(--bg-elevated); display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); }
        .looper-step.filled { background: var(--accent); color: var(--bg-primary); }
        .looper-step.current { box-shadow: 0 0 0 2px var(--text-primary); }
        .looper-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .looper-btn { height: 44px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; }
        .looper-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .looper-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg-primary); }
        .export-section { padding: 16px; }
        .export-buttons { display: flex; gap: 8px; }
        .export-btn { flex: 1; height: 44px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .export-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; }
        .toast { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; padding: 12px 20px; font-size: 13px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideUp 0.3s; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } }
        .hidden { display: none; }
        @media (max-width: 600px) { .main { padding: 12px; gap: 12px; } .pads-grid { gap: 6px; } .pad-number { font-size: 16px; } .controls-row { grid-template-columns: 1fr; } .effects-grid { grid-template-columns: repeat(2, 1fr); } .loop-grid { grid-template-columns: repeat(2, 1fr); } .looper-controls { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="app">
        <header class="header"><div class="logo"><div class="logo-icon">BL</div><div class="logo-text">BREAK<span>LAB</span></div></div></header>
        <main class="main">
            <section class="section"><div class="section-header"><span class="section-title">Select Loop</span><div class="loop-tabs"><button class="loop-tab active" data-tab="classic">Classic</button><button class="loop-tab" data-tab="custom">My Loops</button></div></div><div class="loop-grid" id="loopGrid"></div></section>
            <section class="section"><div class="section-header"><div class="waveform-info"><span class="waveform-name" id="loopName">No loop loaded</span><span class="waveform-bpm" id="loopBpm">-- BPM</span></div><div class="slice-controls"><span style="font-size:11px;color:var(--text-muted)">Slices:</span><div class="slice-count"><button class="slice-btn" id="sliceDown">−</button><span class="slice-value" id="sliceCount">16</span><button class="slice-btn" id="sliceUp">+</button></div></div></div><div class="waveform-container" id="waveformContainer"><canvas class="waveform-canvas" id="waveformCanvas"></canvas><div class="slice-markers" id="sliceMarkers"></div></div></section>
            <section class="section pads-section"><div class="pads-header"><span class="section-title">Trigger Pads</span><div class="pads-mode"><button class="mode-btn active" data-mode="trigger">Trigger</button><button class="mode-btn" data-mode="gate">Gate</button></div></div><div class="pads-grid" id="padsGrid"></div></section>
            <div class="controls-row"><div class="control-group"><div class="control-group-title">Transport</div><div class="transport-buttons"><button class="transport-btn primary" id="playBtn">▶ Play</button><button class="transport-btn" id="stopBtn">■ Stop</button></div></div><div class="control-group"><div class="control-group-title">Tempo</div><div class="tempo-control"><button class="tempo-btn" id="tempoDown">−</button><div class="tempo-display"><div class="tempo-value" id="tempoValue">120</div><div class="tempo-label">BPM</div></div><button class="tempo-btn" id="tempoUp">+</button></div><button class="tap-tempo" id="tapTempo">TAP TEMPO</button></div></div>
            <section class="section effects-section"><div class="section-title" style="margin-bottom:12px">Effects</div><div class="effects-grid"><button class="effect-btn" data-effect="filter">FILTER</button><button class="effect-btn" data-effect="crush">CRUSH</button><button class="effect-btn" data-effect="reverse">REVERSE</button><button class="effect-btn" data-effect="half">HALF</button><button class="effect-btn" data-effect="stutter">STUTTER</button><button class="effect-btn" data-effect="vinyl">VINYL</button><button class="effect-btn" data-effect="pitchUp">PITCH+</button><button class="effect-btn" data-effect="pitchDown">PITCH-</button></div><div class="effect-knobs"><div class="effect-knob"><label class="effect-knob-label">Filter Cutoff</label><input type="range" class="effect-slider" id="filterCutoff" min="100" max="20000" value="20000"></div><div class="effect-knob"><label class="effect-knob-label">Crush Amount</label><input type="range" class="effect-slider" id="crushAmount" min="1" max="16" value="16"></div></div></section>
            <section class="section"><div class="section-header"><span class="section-title">Step Sequencer</span><div class="seq-actions"><button class="seq-btn" id="seqRandom">Random</button><button class="seq-btn" id="seqClear">Clear</button><button class="seq-btn" id="seqPlay">▶ Run</button></div></div><div class="seq-grid" id="seqGrid"></div></section>
            <section class="section looper-section"><div class="looper-header"><span class="section-title">Live Looper</span><span class="looper-status" id="looperStatus">Idle</span></div><div class="looper-display" id="looperDisplay"></div><div class="looper-controls"><button class="looper-btn" id="looperRec">● REC</button><button class="looper-btn" id="looperPlay">▶ PLAY</button><button class="looper-btn" id="looperDub">+ DUB</button><button class="looper-btn" id="looperClear">✕ CLR</button></div></section>
            <section class="section export-section"><div class="section-title" style="margin-bottom:12px">Export</div><div class="export-buttons"><button class="export-btn" id="exportWav">↓ WAV</button><button class="export-btn" id="exportSlices">⊞ Slices</button><button class="export-btn" id="exportPattern">♫ Pattern</button></div></section>
        </main>
    </div>
    <input type="file" id="fileInput" class="hidden" accept="audio/*">
    <div class="toast-container" id="toastContainer"></div>
<script>
const BREAKS=[{id:'amen',name:'Amen Break',bpm:136},{id:'think',name:'Think Break',bpm:120},{id:'funky',name:'Funky Drummer',bpm:102},{id:'apache',name:'Apache',bpm:107},{id:'impeach',name:'Impeach The President',bpm:103},{id:'skull',name:'Skull Snaps',bpm:100},{id:'ashley',name:"Ashley's Roachclip",bpm:112},{id:'hotpants',name:'Hot Pants',bpm:108},{id:'soul',name:'Soul Pride',bpm:115},{id:'synthetic',name:'Synthetic Substitution',bpm:98},{id:'levee',name:'When The Levee Breaks',bpm:71},{id:'president',name:'Funky President',bpm:107}];
const state={ctx:null,buffer:null,loop:null,slices:16,tempo:120,origTempo:120,playing:false,padMode:'trigger',customLoops:[],sources:[],seq:[],seqPlaying:false,seqStep:0,seqInt:null,loopRec:false,loopPlay:false,loopDub:false,loopPat:[],loopStep:0,loopInt:null,loopPlayInt:null,fx:{filter:false,crush:false,reverse:false,half:false,stutter:false,vinyl:false,pitchUp:false,pitchDown:false},filterFreq:20000,crushBits:16,taps:[],masterGain:null,filterNode:null};
const KEYS=['1','2','3','4','5','6','7','8','9','0','q','w','e','r','t','y'];
async function initAudio(){if(state.ctx)return;state.ctx=new(window.AudioContext||window.webkitAudioContext)();state.masterGain=state.ctx.createGain();state.masterGain.gain.value=0.8;state.filterNode=state.ctx.createBiquadFilter();state.filterNode.type='lowpass';state.filterNode.frequency.value=20000;state.filterNode.connect(state.masterGain);state.masterGain.connect(state.ctx.destination)}
function synthKick(L,R,s,sr){const n=Math.floor(0.15*sr);for(let i=0;i<n&&s+i<L.length;i++){const t=i/sr,env=Math.exp(-t*25),f=160*Math.exp(-t*50)+45;const v=Math.sin(2*Math.PI*f*t)*env*0.9;L[s+i]+=v;R[s+i]+=v}}
function synthSnare(L,R,s,sr){const n=Math.floor(0.18*sr);for(let i=0;i<n&&s+i<L.length;i++){const t=i/sr,env=Math.exp(-t*18);const v=Math.sin(2*Math.PI*180*t)*env*0.35+(Math.random()*2-1)*env*0.55;L[s+i]+=v;R[s+i]+=v}}
function synthHat(L,R,s,sr){const n=Math.floor(0.04*sr);for(let i=0;i<n&&s+i<L.length;i++){const t=i/sr,env=Math.exp(-t*80);const v=(Math.random()*2-1)*env*0.18;L[s+i]+=v;R[s+i]+=v}}
function getPattern(id){const p={amen:[[0,'k'],[.0625,'h'],[.125,'s'],[.1875,'h'],[.25,'k'],[.3125,'h'],[.375,'k'],[.4375,'h'],[.5,'k'],[.5625,'h'],[.625,'s'],[.6875,'h'],[.75,'k'],[.8125,'h'],[.875,'s'],[.9375,'h']],think:[[0,'k'],[.125,'h'],[.25,'s'],[.375,'h'],[.5,'k'],[.625,'h'],[.75,'s'],[.875,'h']],funky:[[0,'k'],[.0625,'h'],[.125,'h'],[.1875,'s'],[.25,'h'],[.3125,'k'],[.375,'h'],[.4375,'s'],[.5,'h'],[.5625,'k'],[.625,'h'],[.6875,'s'],[.75,'h'],[.8125,'k'],[.875,'h'],[.9375,'s']],apache:[[0,'k'],[.125,'h'],[.25,'s'],[.375,'h'],[.5,'k'],[.625,'k'],[.75,'s'],[.875,'h']]};return p[id]||p.think}
async function genBreak(info){await initAudio();const sr=state.ctx.sampleRate,dur=(60/info.bpm)*4,len=Math.floor(sr*dur);const buf=state.ctx.createBuffer(2,len,sr);const L=buf.getChannelData(0),R=buf.getChannelData(1);getPattern(info.id).forEach(([t,type])=>{const s=Math.floor(t*len);if(type==='k')synthKick(L,R,s,sr);else if(type==='s')synthSnare(L,R,s,sr);else synthHat(L,R,s,sr)});let max=0;for(let i=0;i<len;i++)max=Math.max(max,Math.abs(L[i]),Math.abs(R[i]));if(max>0){const n=0.9/max;for(let i=0;i<len;i++){L[i]*=n;R[i]*=n}}return buf}
async function loadLoop(info,custom=false){await initAudio();try{if(custom&&info.file){const ab=await info.file.arrayBuffer();state.buffer=await state.ctx.decodeAudioData(ab);state.origTempo=info.bpm||Math.round((4*60)/state.buffer.duration)}else{state.buffer=await genBreak(info);state.origTempo=info.bpm}state.loop=info;state.tempo=state.origTempo;updateUI();drawWaveform();toast(`Loaded: ${info.name}`,'success')}catch(e){console.error(e);toast('Error loading','error')}}
function drawWaveform(){const canvas=document.getElementById('waveformCanvas'),ctx=canvas.getContext('2d');const cont=document.getElementById('waveformContainer');canvas.width=cont.clientWidth*devicePixelRatio;canvas.height=cont.clientHeight*devicePixelRatio;ctx.scale(devicePixelRatio,devicePixelRatio);const w=cont.clientWidth,h=cont.clientHeight;ctx.fillStyle='#1a1a1d';ctx.fillRect(0,0,w,h);if(!state.buffer){ctx.fillStyle='#404045';ctx.font='14px sans-serif';ctx.textAlign='center';ctx.fillText('Select or upload a loop',w/2,h/2);return}const data=state.buffer.getChannelData(0),step=Math.ceil(data.length/w),amp=h/2;ctx.beginPath();ctx.strokeStyle='#ff6b35';ctx.lineWidth=1;for(let i=0;i<w;i++){let min=1,max=-1;for(let j=0;j<step;j++){const d=data[i*step+j]||0;if(d<min)min=d;if(d>max)max=d}ctx.moveTo(i,(1+min)*amp);ctx.lineTo(i,(1+max)*amp)}ctx.stroke();const marks=document.getElementById('sliceMarkers');marks.innerHTML='';for(let i=0;i<state.slices;i++){const m=document.createElement('div');m.className='slice-marker';m.style.left=`${(i/state.slices)*100}%`;marks.appendChild(m)}}
function trigger(idx){if(!state.buffer||!state.ctx)return;const sliceDur=state.buffer.duration/state.slices;let rate=state.tempo/state.origTempo;if(state.fx.half)rate*=0.5;if(state.fx.pitchUp)rate*=1.5;if(state.fx.pitchDown)rate*=0.75;let buf=state.buffer;if(state.fx.reverse){buf=state.ctx.createBuffer(buf.numberOfChannels,buf.length,buf.sampleRate);for(let ch=0;ch<state.buffer.numberOfChannels;ch++){const src=state.buffer.getChannelData(ch),dst=buf.getChannelData(ch);for(let i=0;i<buf.length;i++)dst[i]=src[buf.length-1-i]}}const startTime=state.fx.reverse?buf.duration-(idx+1)*sliceDur:idx*sliceDur;if(state.fx.stutter){const stutterDur=sliceDur/4;for(let i=0;i<4;i++){setTimeout(()=>{const s=state.ctx.createBufferSource();s.buffer=buf;s.playbackRate.value=rate;s.connect(state.filterNode);s.start(0,startTime,stutterDur)},i*stutterDur*1000/rate)}}else{const s=state.ctx.createBufferSource();s.buffer=buf;s.playbackRate.value=rate;if(state.fx.crush&&state.crushBits<16){const shaper=state.ctx.createWaveShaper();const levels=Math.pow(2,state.crushBits),curve=new Float32Array(44100);for(let i=0;i<44100;i++){const x=(i*2)/44100-1;curve[i]=Math.round(x*levels)/levels}shaper.curve=curve;s.connect(shaper);shaper.connect(state.filterNode)}else if(state.fx.vinyl){const bp=state.ctx.createBiquadFilter();bp.type='bandpass';bp.frequency.value=2000;bp.Q.value=0.5;s.connect(bp);bp.connect(state.filterNode)}else{s.connect(state.filterNode)}state.sources.push(s);s.start(0,startTime,sliceDur/rate);s.onended=()=>{const i=state.sources.indexOf(s);if(i>-1)state.sources.splice(i,1);hidePad(idx)}}showPad(idx);if(state.loopRec||state.loopDub){const step=state.loopStep%16;if(!state.loopPat[step])state.loopPat[step]=[];if(!state.loopPat[step].includes(idx))state.loopPat[step].push(idx);renderLooper()}}
function showPad(i){document.querySelector(`.pad[data-idx="${i}"]`)?.classList.add('playing')}
function hidePad(i){document.querySelector(`.pad[data-idx="${i}"]`)?.classList.remove('playing')}
function play(){if(!state.buffer){toast('Load a loop first','error');return}state.playing=true;document.getElementById('playBtn').textContent='❚❚ Pause';if(state.loopPat.some(p=>p?.length))startLooperPlay();if(state.seqPlaying)startSeq()}
function stop(){state.playing=false;document.getElementById('playBtn').textContent='▶ Play';state.sources.forEach(s=>{try{s.stop()}catch(e){}});state.sources=[];stopSeq();stopLooper()}
function setTempo(v){state.tempo=Math.max(40,Math.min(300,v));document.getElementById('tempoValue').textContent=Math.round(state.tempo)}
function tap(){const now=performance.now();state.taps.push(now);if(state.taps.length>4)state.taps.shift();if(state.taps.length>=2){let total=0;for(let i=1;i<state.taps.length;i++)total+=state.taps[i]-state.taps[i-1];setTempo(60000/(total/(state.taps.length-1)))}setTimeout(()=>{if(state.taps.length&&performance.now()-state.taps[state.taps.length-1]>2000)state.taps=[]},2000)}
function toggleFx(name){state.fx[name]=!state.fx[name];if(name==='filter')state.filterNode.frequency.value=state.fx.filter?state.filterFreq:20000;document.querySelectorAll('.effect-btn').forEach(b=>b.classList.toggle('active',state.fx[b.dataset.effect]))}
function initSeq(){state.seq=[];for(let i=0;i<Math.min(8,state.slices);i++)state.seq.push(new Array(16).fill(false));renderSeq()}
function renderSeq(){const grid=document.getElementById('seqGrid');grid.innerHTML='';for(let r=0;r<state.seq.length;r++){const row=document.createElement('div');row.className='seq-row';const label=document.createElement('div');label.className='seq-label';label.textContent=r+1;row.appendChild(label);const steps=document.createElement('div');steps.className='seq-steps';for(let s=0;s<16;s++){const step=document.createElement('div');step.className='seq-step';step.dataset.row=r;step.dataset.step=s;if(state.seq[r][s])step.classList.add('active');step.onclick=()=>{state.seq[r][s]=!state.seq[r][s];step.classList.toggle('active')};steps.appendChild(step)}row.appendChild(steps);grid.appendChild(row)}}
function startSeq(){if(state.seqInt)clearInterval(state.seqInt);state.seqStep=0;const dur=(60/state.tempo)*1000/4;state.seqInt=setInterval(()=>{if(!state.playing)return;state.seq.forEach((row,i)=>{if(row[state.seqStep])trigger(i)});document.querySelectorAll('.seq-step').forEach(el=>el.classList.toggle('current',+el.dataset.step===state.seqStep));state.seqStep=(state.seqStep+1)%16},dur)}
function stopSeq(){if(state.seqInt){clearInterval(state.seqInt);state.seqInt=null}document.querySelectorAll('.seq-step').forEach(el=>el.classList.remove('current'))}
function initLooper(){state.loopPat=new Array(16).fill(null);renderLooper()}
function renderLooper(){const disp=document.getElementById('looperDisplay');disp.innerHTML='';for(let i=0;i<16;i++){const step=document.createElement('div');step.className='looper-step';if(state.loopPat[i]?.length){step.classList.add('filled');step.textContent=state.loopPat[i][0]+1}if(i===state.loopStep&&(state.loopPlay||state.loopRec))step.classList.add('current');disp.appendChild(step)}}
function startLooperRec(){state.loopRec=true;state.loopStep=0;updateLooperStatus();const dur=(60/state.tempo)*1000/4;state.loopInt=setInterval(()=>{state.loopStep=(state.loopStep+1)%16;renderLooper()},dur)}
function startLooperPlay(){if(state.loopPlayInt)clearInterval(state.loopPlayInt);state.loopPlay=true;state.loopStep=0;updateLooperStatus();const dur=(60/state.tempo)*1000/4;state.loopPlayInt=setInterval(()=>{if(state.loopPat[state.loopStep])state.loopPat[state.loopStep].forEach(i=>trigger(i));state.loopStep=(state.loopStep+1)%16;renderLooper()},dur)}
function stopLooper(){if(state.loopPlayInt){clearInterval(state.loopPlayInt);state.loopPlayInt=null}if(state.loopInt){clearInterval(state.loopInt);state.loopInt=null}state.loopPlay=state.loopRec=state.loopDub=false;updateLooperStatus()}
function clearLooper(){stopLooper();state.loopPat=new Array(16).fill(null);renderLooper()}
function updateLooperStatus(){const el=document.getElementById('looperStatus');el.textContent=state.loopRec?'Recording...':state.loopPlay?'Playing':'Idle';el.className='looper-status'+(state.loopRec?' recording':state.loopPlay?' playing':'');document.getElementById('looperRec').classList.toggle('active',state.loopRec);document.getElementById('looperPlay').classList.toggle('active',state.loopPlay);document.getElementById('looperDub').classList.toggle('active',state.loopDub)}
function bufToWav(buf){const numCh=buf.numberOfChannels,sr=buf.sampleRate,len=buf.length;const ab=new ArrayBuffer(44+len*numCh*2),v=new DataView(ab);const writeStr=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};writeStr(0,'RIFF');v.setUint32(4,36+len*numCh*2,true);writeStr(8,'WAVE');writeStr(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,numCh,true);v.setUint32(24,sr,true);v.setUint32(28,sr*numCh*2,true);v.setUint16(32,numCh*2,true);v.setUint16(34,16,true);writeStr(36,'data');v.setUint32(40,len*numCh*2,true);const chs=[];for(let i=0;i<numCh;i++)chs.push(buf.getChannelData(i));let off=44;for(let i=0;i<len;i++)for(let ch=0;ch<numCh;ch++){const s=Math.max(-1,Math.min(1,chs[ch][i]));v.setInt16(off,s<0?s*0x8000:s*0x7FFF,true);off+=2}return ab}
function exportWav(){if(!state.buffer){toast('No loop','error');return}const wav=bufToWav(state.buffer),blob=new Blob([wav],{type:'audio/wav'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${state.loop?.name||'break'}.wav`;a.click();toast('WAV exported!','success')}
async function exportSlices(){if(!state.buffer){toast('No loop','error');return}const sliceSamples=Math.floor(state.buffer.length/state.slices);for(let i=0;i<state.slices;i++){const buf=state.ctx.createBuffer(state.buffer.numberOfChannels,sliceSamples,state.buffer.sampleRate);for(let ch=0;ch<state.buffer.numberOfChannels;ch++){const src=state.buffer.getChannelData(ch),dst=buf.getChannelData(ch);for(let j=0;j<sliceSamples;j++)dst[j]=src[i*sliceSamples+j]||0}const wav=bufToWav(buf),blob=new Blob([wav],{type:'audio/wav'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${state.loop?.name||'break'}_${String(i+1).padStart(2,'0')}.wav`;a.click();await new Promise(r=>setTimeout(r,100))}toast(`${state.slices} slices exported!`,'success')}
function exportPattern(){const data={tempo:state.tempo,slices:state.slices,pattern:state.seq.map((r,i)=>({slice:i+1,steps:r.map((a,s)=>a?s:null).filter(s=>s!==null)})).filter(r=>r.steps.length)};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${state.loop?.name||'break'}_pattern.json`;a.click();toast('Pattern exported!','success')}
function renderLoopGrid(){const grid=document.getElementById('loopGrid'),tab=document.querySelector('.loop-tab.active').dataset.tab;grid.innerHTML='';if(tab==='classic'){BREAKS.forEach(l=>{const card=document.createElement('div');card.className='loop-card'+(state.loop?.id===l.id?' active':'');card.innerHTML=`<div class="loop-card-name">${l.name}</div><div class="loop-card-meta">${l.bpm} BPM</div>`;card.onclick=()=>loadLoop(l);grid.appendChild(card)})}else{const up=document.createElement('div');up.className='loop-card upload-card';up.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><span>Upload Loop</span>';up.onclick=()=>document.getElementById('fileInput').click();grid.appendChild(up);state.customLoops.forEach(l=>{const card=document.createElement('div');card.className='loop-card'+(state.loop?.id===l.id?' active':'');card.innerHTML=`<div class="loop-card-name">${l.name}</div><div class="loop-card-meta">${l.bpm||'Uploaded'}</div>`;card.onclick=()=>loadLoop(l,true);grid.appendChild(card)})}}
function renderPads(){const grid=document.getElementById('padsGrid');grid.innerHTML='';for(let i=0;i<state.slices;i++){const pad=document.createElement('div');pad.className='pad';pad.dataset.idx=i;pad.innerHTML=`<span class="pad-number">${i+1}</span>${KEYS[i]?`<span class="pad-key">${KEYS[i].toUpperCase()}</span>`:''}`;pad.onmousedown=e=>{e.preventDefault();trigger(i);pad.classList.add('active')};pad.onmouseup=pad.onmouseleave=()=>pad.classList.remove('active');pad.ontouchstart=e=>{e.preventDefault();trigger(i);pad.classList.add('active')};pad.ontouchend=()=>pad.classList.remove('active');grid.appendChild(pad)}}
function updateUI(){document.getElementById('loopName').textContent=state.loop?.name||'No loop loaded';document.getElementById('loopBpm').textContent=state.origTempo?`${state.origTempo} BPM`:'-- BPM';document.getElementById('tempoValue').textContent=Math.round(state.tempo);document.getElementById('sliceCount').textContent=state.slices;renderPads();initSeq()}
function toast(msg,type='info'){const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;document.getElementById('toastContainer').appendChild(t);setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300)},3000)}
function setup(){document.querySelectorAll('.loop-tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.loop-tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');renderLoopGrid()});document.getElementById('sliceUp').onclick=()=>{if(state.slices<32){state.slices*=2;updateUI();drawWaveform()}};document.getElementById('sliceDown').onclick=()=>{if(state.slices>4){state.slices/=2;updateUI();drawWaveform()}};document.querySelectorAll('.mode-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.padMode=b.dataset.mode});document.getElementById('playBtn').onclick=()=>state.playing?stop():play();document.getElementById('stopBtn').onclick=stop;document.getElementById('tempoUp').onclick=()=>setTempo(state.tempo+1);document.getElementById('tempoDown').onclick=()=>setTempo(state.tempo-1);document.getElementById('tapTempo').onclick=tap;document.querySelectorAll('.effect-btn').forEach(b=>b.onclick=()=>toggleFx(b.dataset.effect));document.getElementById('filterCutoff').oninput=e=>{state.filterFreq=+e.target.value;if(state.fx.filter)state.filterNode.frequency.value=state.filterFreq};document.getElementById('crushAmount').oninput=e=>{state.crushBits=+e.target.value};document.getElementById('seqRandom').onclick=()=>{state.seq.forEach((r,i)=>{for(let s=0;s<16;s++)state.seq[i][s]=Math.random()<0.2});renderSeq()};document.getElementById('seqClear').onclick=()=>{state.seq.forEach((r,i)=>state.seq[i].fill(false));renderSeq()};document.getElementById('seqPlay').onclick=()=>{state.seqPlaying=!state.seqPlaying;document.getElementById('seqPlay').classList.toggle('active',state.seqPlaying);if(state.seqPlaying&&state.playing)startSeq();else stopSeq()};document.getElementById('looperRec').onclick=()=>{if(state.loopRec)stopLooper();else startLooperRec()};document.getElementById('looperPlay').onclick=()=>{if(state.loopPlay)stopLooper();else startLooperPlay()};document.getElementById('looperDub').onclick=()=>{state.loopDub=!state.loopDub;updateLooperStatus()};document.getElementById('looperClear').onclick=clearLooper;document.getElementById('exportWav').onclick=exportWav;document.getElementById('exportSlices').onclick=exportSlices;document.getElementById('exportPattern').onclick=exportPattern;document.getElementById('fileInput').onchange=async e=>{const f=e.target.files[0];if(!f)return;const info={id:'c_'+Date.now(),name:f.name.replace(/\.[^/.]+$/,''),file:f,bpm:null};state.customLoops.push(info);await loadLoop(info,true);renderLoopGrid()};document.addEventListener('keydown',e=>{if(e.code==='Space'&&e.target.tagName!=='INPUT'){e.preventDefault();state.playing?stop():play()}const i=KEYS.indexOf(e.key.toLowerCase());if(i!==-1&&i<state.slices){trigger(i);document.querySelector(`.pad[data-idx="${i}"]`)?.classList.add('active')}});document.addEventListener('keyup',e=>{const i=KEYS.indexOf(e.key.toLowerCase());if(i!==-1)document.querySelector(`.pad[data-idx="${i}"]`)?.classList.remove('active')});window.addEventListener('resize',drawWaveform);document.getElementById('waveformContainer').onclick=e=>{if(!state.buffer)return;const rect=e.target.getBoundingClientRect();trigger(Math.floor((e.clientX-rect.left)/rect.width*state.slices))};document.addEventListener('click',initAudio,{once:true});document.addEventListener('touchstart',initAudio,{once:true})}
document.addEventListener('DOMContentLoaded',()=>{renderLoopGrid();renderPads();initSeq();initLooper();setup();drawWaveform();loadLoop(BREAKS[0])});
</script>
</body>
</html>
